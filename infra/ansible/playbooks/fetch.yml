---
# ==============================================================================
# FILE: infra/ansible/playbooks/fetch.yml
# VERSION: 0.6.1 (Compressed Support Patch)
# MAINTAINER: DevOps / Research Team
# DATE: 2026-01-11
# ==============================================================================
# DESCRIPTION:
#   Orchestrates the retrieval of scientific datasets from remote sensors.
#   Supports dynamic node discovery (North/East/West).
#
# CHANGELOG:
#   - 0.6.1: Added support for .csv.gz (compressed) logs to prevent skipping.
#   - 0.5.0: Removed legacy jinja2 conditional. Now uses {{ inventory_hostname }}
# ==============================================================================

- name: "ðŸ“¥ Grid Data Retrieval (Scientific Data Pipeline)"
  hosts: sensors
  gather_facts: yes
  become: yes
    
  tasks:
    # --- 1. DYNAMIC DISCOVERY ---
    - name: "[Discovery] Locate all generated CSV research logs"
      find:
        paths: "/var/lib/adsb_storage/csv_data"
        patterns: 
          - "*.csv"
          - "*.csv.gz"   # <--- CRITICAL FIX: Finds compressed logs
        age: "-1d"       # Only files modified in the last 24h
      register: csv_files

    # --- 2. DATA INGESTION ---
    - name: "[Ingest] Transfer CSV logs to Local Research Repository"
      fetch:
        src: "{{ item.path }}"
        # DEVOPS COMMENT: 
        # Dynamic path resolution. 
        # Result: research_data/2026-01-11/sensor-east/filename.csv
        dest: "{{ playbook_dir }}/../../../research_data/{{ ansible_date_time.date }}/{{ inventory_hostname }}/"
        flat: yes
      with_items: "{{ csv_files.files }}"
      loop_control:
        label: "{{ item.path | basename }}"

    - name: "[Ingest] Retrieve Storage History (Metrics)"
      fetch:
        src: "/var/lib/adsb_storage/storage_history.csv"
        # DEVOPS COMMENT: 
        # Downloads individual node history for merging later.
        dest: "{{ playbook_dir }}/../../../research_data/{{ ansible_date_time.date }}/{{ inventory_hostname }}/storage_history.csv"
        flat: yes
      ignore_errors: yes
