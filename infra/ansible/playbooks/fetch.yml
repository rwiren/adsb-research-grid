---
# ==============================================================================
# ðŸ“¥ PROJECT: ADS-B Spoofing Data Collection
# ðŸ“‚ FILE:    infra/ansible/playbooks/fetch.yml
# ðŸ”¢ VERSION: 0.7.2 (Expanded Data Scope: GNSS + Health)
# ðŸ“… DATE:    2026-01-13
# âœï¸ AUTHOR:  Gemini / ADSB Team
# ==============================================================================

- name: "ðŸ“¥ Grid Data Retrieval (Scientific Data Pipeline)"
  hosts: sensors
  gather_facts: yes
  vars:
    local_data_dir: "research_data/raw"
    remote_data_dir: "/opt/adsb-grid/data"

  tasks:
    - name: "[Discovery] Locate all generated CSV research logs"
      find:
        paths: "{{ remote_data_dir }}"
        # REFINED v0.7.2: Capture ALL scientific log types
        patterns: 
          - "*_aircraft_log_*.csv"     # Primary Flight Tracks
          - "*_stats_log_*.csv"        # SDR/Decoder Hardware Stats
          - "*_gnss_log_*.csv"         # [NEW] GPS/RTK Position Fixes
          - "*hardware_health*.csv"    # [NEW] System Crash/Throttling Logs
          - "*storage_*.csv"           # [NEW] Disk Usage History
          - "*.csv.gz"                 # Archived/Compressed Logs
        recurse: yes
      register: found_logs

    - name: "[Ingest] Transfer CSV logs to Local Research Repository"
      fetch:
        src: "{{ item.path }}"
        dest: "{{ local_data_dir }}/{{ inventory_hostname }}/"
        flat: yes
      loop: "{{ found_logs.files }}"
      loop_control:
        label: "{{ item.path | basename }}"
      when: found_logs.matched > 0

    - name: "[Ingest] Retrieve Storage History (Metrics)"
      shell: "du -sk /opt/adsb-grid/data | awk '{print $1}'"
      register: storage_usage
      changed_when: false

    - name: "[Meta] Save Storage Metrics"
      local_action: 
        module: lineinfile
        path: "data/storage_history.csv"
        line: "{{ ansible_date_time.iso8601 }},{{ inventory_hostname }},{{ storage_usage.stdout }}"
        create: yes
