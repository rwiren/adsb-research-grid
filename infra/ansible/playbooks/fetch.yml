---
# ==============================================================================
# ðŸ“¥ PROJECT: ADS-B Spoofing Data Collection
# ðŸ“‚ FILE:    infra/ansible/playbooks/fetch.yml
# ðŸ”¢ VERSION: 0.7.5 (Live File Checksum Fix)
# ðŸ“… DATE:    2026-01-14
# ==============================================================================

- name: "ðŸ“¥ Grid Data Retrieval (Scientific Data Pipeline)"
  hosts: sensors
  gather_facts: yes
  vars:
    local_data_dir: "research_data/raw"
    # Point to the parent folder containing health files + csv_data folder
    remote_data_dir: "/var/lib/adsb_storage"

  tasks:
    - name: "[Discovery] Locate all generated CSV research logs"
      find:
        paths: "{{ remote_data_dir }}"
        # Capture files in root AND inside 'csv_data'
        patterns: 
          - "*.csv"
          - "*.json"
          - "*.gz"
          - "*.log"
        recurse: yes
      register: found_logs

    - name: "[Ingest] Transfer logs to Local Research Repository"
      fetch:
        src: "{{ item.path }}"
        dest: "{{ local_data_dir }}/{{ inventory_hostname }}/"
        flat: yes
        # CRITICAL: Disable checksum for live files that grow during transfer
        validate_checksum: no
      loop: "{{ found_logs.files }}"
      loop_control:
        label: "{{ item.path | basename }}"
      when: found_logs.matched > 0
