---
# ==============================================================================
# File: infra/ansible/playbooks/setup_data_manager.yml
# Description: Deploys the Data Management agent.
#              - Compresses old CSVs to .gz
#              - Rotates logs to prevent disk full events.
# ==============================================================================

- name: üõ°Ô∏è Setup Data Management (Compression & Verification)
  hosts: sensors
  become: true
  vars:
    # Path relative to where ansible-playbook is run (infra/ansible)
    local_script_path: "../../../scripts/data_manager.py"
    remote_script_dir: "/home/{{ ansible_user }}/scripts"

  tasks:
    - name: "[Setup] Create scripts directory on sensor"
      ansible.builtin.file:
        path: "{{ remote_script_dir }}"
        state: directory
        mode: '0755'

    - name: "[Deploy] Copy Data Manager Script"
      ansible.builtin.copy:
        src: "{{ local_script_path }}"
        dest: "{{ remote_script_dir }}/data_manager.py"
        mode: '0755'

    - name: "[Schedule] Run Data Manager (Every 15 mins)"
      ansible.builtin.cron:
        name: "Run Data Manager (Compress & Verify)"
        minute: "*/15"
        job: "/usr/bin/python3 {{ remote_script_dir }}/data_manager.py"
