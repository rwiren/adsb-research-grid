# ==============================================================================
# ðŸ“œ File: infra/ansible/playbooks/site.yml
# Version: v0.8.0 (Added Centralized Logging & Fluent Bit Support)
# Date: 2026-01-14
# Author: ADSB Research Grid Team
# Description: Master Playbook for Sensor Grid & Tower Core Deployment
# ==============================================================================

- name: "[sensors] Configure Sensor Nodes"
  hosts: sensors
  become: true

  # Global variables usually go in group_vars, but we can ensure defaults here
  vars:
    pip_install_packages: []

  roles:
    # 1. System & Network (The Base)
    - role: common
      tags: [common, system]

    - role: zerotier
      tags: [zerotier, network]

    # 2. Hardware: GNSS Receiver (RTK/GPS)
    - role: gnss-receiver
      tags: [gnss, rtk, hardware]

    # 3. Hardware: SDR & Decoder (The "Ears")
    # (Only run if variables are defined for the host)
    - role: sensor_node
      # [UPDATED v0.8.0] Added 'logging' to deploy Fluent Bit
      tags: [sdr, adsb, decoder, telegraf, monitoring, logging]

    # 4. Data Recording (The "Brain")
    - role: recorder
      tags: [recorder, data]

    # 5. Precise Timing (Stratum 1)
    - role: strat1_timing
      tags: [chrony, time, pps]

# ==============================================================================
# [PLAY] TOWER CORE: Central Nervous System
# ==============================================================================
- name: "[core] Configure Tower Node"
  hosts: core
  become: true

  vars:
    # Override install path for the Tower
    install_path: /opt/tower

  roles:
    # 1. Base System & Network
    - role: common
      tags: [common, system]

    - role: zerotier
      tags: [zerotier, network]

    # 2. The Stack (TIG + MQTT + Syslog + OpenSearch)
    - role: tower_core
      # [UPDATED v0.8.0] Added 'logging' for Fluent Bit Aggregator
      tags: [stack, docker, core, grafana, influxdb, telegraf, logging]

# ==============================================================================
# [IMPORTS] Operational Support Playbooks
# ==============================================================================
- import_playbook: health.yml
- import_playbook: setup_data_manager.yml
- import_playbook: setup_metrics_collector.yml
