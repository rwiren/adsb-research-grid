---
# ==============================================================================
# ROLE: GNSS Receiver
# FILE: infra/ansible/roles/gnss-receiver/tasks/main.yml
# VERSION: 0.4.4
# ==============================================================================

- name: "[Common] Install GPSD, socat, and Tools"
  apt:
    name:
      - gpsd
      - gpsd-clients
      - python3-gps
      - pps-tools
      - socat
    state: present
    update_cache: yes

# ... (Include RTKLIB compile tasks here if not already present) ...

# ------------------------------------------------------------------------------
# ARCHITECTURE COMPONENT 1: THE DATA HUB (North Only)
# ------------------------------------------------------------------------------
- name: "[Hub] Deploy socat Data Hub Service"
  template:
    src: gnss-socat-hub.service.j2
    dest: /etc/systemd/system/gnss-socat-hub.service
    mode: '0644'
  notify: Restart Data Hub
  when: socat_hub_port is defined

# ------------------------------------------------------------------------------
# ARCHITECTURE COMPONENT 2: THE NTRIP CLIENT (North Only)
# ------------------------------------------------------------------------------
- name: "[RTK] Deploy NTRIP Client Service"
  template:
    src: gnss-ntrip-client.service.j2
    dest: /etc/systemd/system/gnss-ntrip-client.service
    mode: '0644'
  notify: Restart NTRIP Client
  when: socat_hub_port is defined

# ------------------------------------------------------------------------------
# ARCHITECTURE COMPONENT 3: GPSD CONFIGURATION
# ------------------------------------------------------------------------------
- name: "[Common] Configure GPSD"
  template:
    src: gpsd.j2
    dest: /etc/default/gpsd
  notify: Restart GPSD
