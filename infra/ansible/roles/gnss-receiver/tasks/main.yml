---
# Role: gnss-receiver
# Version: 2.0.0
# Description: Smart role that installs GPSD for standard nodes OR RTKLIB for RTK nodes.

# ==========================================
# ðŸŸ¢ STANDARD GPS NODE (Sensor-West)
# ==========================================
- name: "[Standard] Install GPSD and Tools"
  apt:
    name:
      - gpsd
      - gpsd-clients
      - python3-gps
    state: present
  become: yes
  when: ntrip_host is not defined

- name: "[Standard] Configure GPSD"
  template:
    src: gpsd.j2
    dest: /etc/default/gpsd
    mode: '0644'
  become: yes
  notify: Restart GPSD
  when: ntrip_host is not defined

- name: "[Standard] Ensure GPSD is Started"
  service:
    name: gpsd
    state: started
    enabled: yes
  become: yes
  when: ntrip_host is not defined

# ==========================================
# ðŸ”µ HIGH PRECISION RTK NODE (Sensor-North)
# ==========================================
- name: "[RTK] Install Build Dependencies"
  apt:
    name:
      - build-essential
      - cmake
      - libusb-1.0-0-dev
    state: present
  become: yes
  when: ntrip_host is defined

- name: "[RTK] Clone RTKLIB"
  git:
    repo: 'https://github.com/rtklibexplorer/RTKLIB.git'
    dest: /opt/RTKLIB
    version: master
  become: yes
  when: ntrip_host is defined

- name: "[RTK] Compile RTKLIB (str2str)"
  make:
    chdir: /opt/RTKLIB/app/str2str/gcc
  become: yes
  when: ntrip_host is defined

- name: "[RTK] Install str2str Binary"
  copy:
    src: /opt/RTKLIB/app/str2str/gcc/str2str
    dest: /usr/local/bin/str2str
    mode: '0755'
    remote_src: yes
  become: yes
  when: ntrip_host is defined

- name: "[RTK] Copy U-blox Initialization Script"
  copy:
    src: ublox_init.sh
    dest: /usr/local/bin/ublox_init.sh
    mode: '0755'
  become: yes
  when: ntrip_host is defined

- name: "[RTK] Deploy GNSS Configurator Service"
  template:
    src: gnss-configurator.service.j2
    dest: /etc/systemd/system/gnss-configurator.service
    mode: '0644'
  become: yes
  notify: Reload Systemd
  when: ntrip_host is defined

- name: "[RTK] Deploy NTRIP Client Service"
  template:
    src: gnss-ntrip-client.service.j2
    dest: /etc/systemd/system/gnss-ntrip-client.service
    mode: '0644'
  become: yes
  notify: Restart NTRIP Client
  when: ntrip_host is defined
