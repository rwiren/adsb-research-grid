---
# ==============================================================================
# FILE: infra/ansible/roles/recorder/tasks/main.yml
# VERSION: 0.5.0
# DESCRIPTION: Deploys the Smart Logger and manages data persistence paths.
# ==============================================================================

- name: "[Storage] Ensure Data Persistence Directory Exists"
  ansible.builtin.file:
    path: "/var/lib/adsb_storage"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'
  become: true

- name: Ensure ADSB Sensor Directory Exists (/opt)
  ansible.builtin.file:
    path: /opt/adsb-sensor
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'

- name: Deploy Smart Logger Script (v1.4.0)
  ansible.builtin.copy:
    src: smart_adsb_logger.py
    dest: /opt/adsb-sensor/smart_adsb_logger.py
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'
  notify: Restart Smart Logger

- name: Deploy Service Definition
  ansible.builtin.template:
    src: smart-logger.service.j2
    dest: /etc/systemd/system/smart-logger.service
    owner: root
    group: root
    mode: '0644'
  notify: Restart Smart Logger

- name: Ensure Smart Logger is Running and Enabled
  ansible.builtin.systemd:
    name: smart-logger
    enabled: yes
    state: started
    daemon_reload: yes
