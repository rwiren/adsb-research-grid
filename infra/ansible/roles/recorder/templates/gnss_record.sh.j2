#!/bin/bash
# ==============================================================================
# PROJECT: ADS-B Spoofing Data Collection (Academic Research)
# FILE: infra/ansible/roles/recorder/templates/gnss_record.sh.j2
# DEPLOY TARGET: /usr/local/bin/gnss_record.sh
# VERSION: 0.4.0
#
# DESCRIPTION:
#   Records Raw GNSS data to daily logs.
#   - Implements "Smart Recording" to resolve resource contention.
#   - Adapts method based on node role (RTK Base vs Production Scout).
# ==============================================================================

# 1. SETUP VARIABLES
DATE=$(date +%Y-%m-%d)
HOSTNAME=$(hostname)
LOG_DIR="/data/gnss_raw"
LOG_FILE="${LOG_DIR}/${HOSTNAME}_gnss_raw_${DATE}.log"
META_FILE="${LOG_FILE}.meta"

# Safety: Ensure directory exists (Redundant to Ansible, but good for portability)
mkdir -p "$LOG_DIR"

# 2. METADATA HEADER
# Tracks when recording started to correlate with spoofing experiments.
echo "----------------------------------------------------------------" >> "$META_FILE"
echo "START: $(date -Iseconds)" >> "$META_FILE"
echo "HOST:  $HOSTNAME" >> "$META_FILE"

# 3. RECORDING LOGIC (Heterogeneous)

{% if ntrip_caster is defined %}
# --- CASE A: SENSOR-NORTH (RTK Base) ---
# HARDWARE: UART (/dev/ttyAMA0) is locked by str2str.
# STRATEGY: Network Dump.
# We record the TCP stream broadcast by str2str on Port 2000.
# This ensures we capture the exact raw binary (UBX) data used for RTK.
# -------------------------------------------------------
echo "MODE:  TCP Stream Dump (Port 2000)" >> "$META_FILE"
exec /bin/nc localhost 2000 >> "$LOG_FILE"

{% else %}
# --- CASE B: SENSOR-WEST (Standard USB) ---
# HARDWARE: USB (/dev/ttyUSB0) is locked by gpsd.
# STRATEGY: GPS Pipe.
# We cannot read the serial port directly without crashing gpsd.
# We use 'gpspipe' to request a raw data copy from the daemon.
# -R : Raw NMEA/Binary data (preserves original hardware output)
# -------------------------------------------------------
echo "MODE:  GPSD Pipe (Raw)" >> "$META_FILE"
# Small delay to ensure gpsd is fully ready after service restart
sleep 5
exec /usr/bin/gpspipe -R >> "$LOG_FILE"

{% endif %}
