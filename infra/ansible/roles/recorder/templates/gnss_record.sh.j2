#!/bin/bash
# ==============================================================================
# üõ∞Ô∏è SERVICE: GNSS Data Recorder (Scientific)
# üìÇ FILE:    /usr/local/bin/gnss_record.sh
# üî¢ VERSION: 0.9.0 (Added Integrity Metrics: Sats + HDOP)
# ------------------------------------------------------------------------------
# DESCRIPTION: 
#   - Standard Nodes: Connects to GPSD. Correlates SKY (Satellites) and TPV (Position)
#     messages to produce a complete scientific log.
#   - RTK Base Nodes: Dumps TCP Stream from str2str (Raw/Binary).
# ==============================================================================

# 1. Config
HOSTNAME="{{ inventory_hostname }}"
LOG_DIR="/var/lib/adsb_storage/csv_data"
DATE=$(date +%Y-%m-%d)
CSV_FILE="${LOG_DIR}/${HOSTNAME}_gnss_log_${DATE}.csv"
RAW_FILE="${LOG_DIR}/${HOSTNAME}_gnss_raw_${DATE}.log"

# Ensure Directory Exists
mkdir -p "$LOG_DIR"
chmod 755 "$LOG_DIR"

# ------------------------------------------------------------------------------
# MODE A: RTK BASE STATION (Sensor-North)
# ------------------------------------------------------------------------------
{% if inventory_hostname == 'sensor-north' %}
echo "[$0] üì° RTK MODE: Dumping TCP Stream (Port 2000) to $RAW_FILE"
exec /bin/nc localhost 2000 >> "$RAW_FILE"

# ------------------------------------------------------------------------------
# MODE B: STANDARD SENSOR (West/East)
# ------------------------------------------------------------------------------
{% else %}
echo "[$0] üõ∞Ô∏è STANDARD MODE: Starting Scientific Python Logger..."
echo "[$0] üìÇ Target File: $CSV_FILE"

cat <<EOF > /tmp/gnss_logger.py
import gps
import csv
import time
import os
import sys

LOG_FILE = "$CSV_FILE"
HOSTNAME = "$HOSTNAME"

def run_logger():
    print(f"[*] Initializing Scientific GPSD connection...")
    
    # 1. Ensure Header Exists (With new columns)
    try:
        if not os.path.exists(LOG_FILE):
            print(f"[*] Creating new log file: {LOG_FILE}")
            with open(LOG_FILE, 'w', newline='') as f:
                writer = csv.writer(f)
                writer.writerow(['timestamp_utc', 'hostname', 'lat', 'lon', 'alt_m', 'speed_mps', 'track_deg', 'climb_mps', 'mode', 'sats_used', 'hdop'])
                f.flush()
        else:
            print(f"[*] Appending to existing file: {LOG_FILE}")
    except Exception as e:
        print(f"[!] FAILED to create file: {e}")
        sys.exit(1)

    # 2. State Variables (To sync SKY and TPV messages)
    current_sats = 0
    current_hdop = 99.99

    # 3. GPSD Loop
    try:
        session = gps.gps(mode=gps.WATCH_ENABLE | gps.WATCH_NEWSTYLE)
        print("[*] Connected to GPSD. Listening for Satellites & Position...")
        
        while True:
            try:
                report = session.next()
                
                # --- CASE 1: Satellite View (SKY) ---
                # Updates our knowledge of the sky quality
                if report['class'] == 'SKY':
                    if 'hdop' in report:
                        current_hdop = report['hdop']
                    
                    if 'satellites' in report:
                        # Count only satellites actually used in the fix
                        used_sats = [s for s in report['satellites'] if hasattr(s, 'used') and s.used]
                        current_sats = len(used_sats)

                # --- CASE 2: Position Fix (TPV) ---
                # Writes the row using the latest known sky data
                elif report['class'] == 'TPV':
                    mode = report.get('mode', 0)
                    
                    if mode >= 2: # 2D or 3D Fix
                        ts = report.get('time', '')
                        lat = report.get('lat', '')
                        lon = report.get('lon', '')
                        
                        if ts and lat and lon:
                            with open(LOG_FILE, 'a', newline='') as f:
                                writer = csv.writer(f)
                                writer.writerow([
                                    ts, HOSTNAME, lat, lon, 
                                    report.get('alt', ''), 
                                    report.get('speed', ''), 
                                    report.get('track', ''), 
                                    report.get('climb', ''), 
                                    mode,
                                    current_sats,  # <--- NEW
                                    current_hdop   # <--- NEW
                                ])
            except StopIteration:
                print("[!] GPSD Connection Lost.")
                break
                
    except Exception as e:
        print(f"[!] Stream Error: {e}")
        sys.exit(1)

if __name__ == "__main__":
    run_logger()
EOF

# Execute with unbuffered output
python3 -u /tmp/gnss_logger.py
{% endif %}
