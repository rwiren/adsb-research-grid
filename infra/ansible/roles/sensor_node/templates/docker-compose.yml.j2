version: '3.8'

services:
  # --- CORE DECODER ---
  readsb:
    image: ghcr.io/sdr-enthusiasts/docker-readsb-protobuf:latest
    container_name: readsb
    restart: always
    tty: true
    devices:
      - /dev/bus/usb:/dev/bus/usb
    ports:
      - "8080:8080"   # Web Map
      - "30005:30005" # Beast Output
    environment:
      - TZ={{ timezone }}
      - READSB_DEVICE_TYPE=rtlsdr
      - READSB_NET_ENABLE=true
      - READSB_DCFILTER=true
      - READSB_FIX=true
      - READSB_GAIN={{ adsb_gain }}
      - READSB_LAT={{ lat }}
      - READSB_LON={{ lon }}
      - READSB_ALT={{ alt }}
    tmpfs:
      - /run/readsb
      - /var/log

  # --- FEEDERS (Conditional) ---

  piaware:
    image: flightaware/piaware:latest
    restart: always
    environment:
      - BEASTHOST=readsb
      - BEASTPORT=30005
      - ALLOW_MLAT=yes
      - MLAT_RESULTS=yes
      # Only inject ID if defined in host_vars
      {% if piaware_feeder_id is defined %}
      - FEEDER_ID={{ piaware_feeder_id }}
      {% endif %}
    depends_on:
      - readsb

  fr24feed:
    image: flightradar24/fr24feed:latest
    restart: always
    environment:
      - BEASTHOST=readsb
      - BEASTPORT=30005
      {% if fr24_key is defined %}
      - FR24KEY={{ fr24_key }}
      {% endif %}
    depends_on:
      - readsb

  planefinder:
    image: planefinder/pfclient:latest
    restart: always
    environment:
      - BEASTHOST=readsb
      - BEASTPORT=30005
      {% if pf_sharecode is defined %}
      - SHARECODE={{ pf_sharecode }}
      {% endif %}
    ports:
      - "30053:30053"
    depends_on:
      - readsb

  radarbox:
    image: ghcr.io/sdr-enthusiasts/docker-radarbox-flightstick:latest
    restart: always
    environment:
      - BEASTHOST=readsb
      - BEASTPORT=30005
      {% if rb_key is defined %}
      - SHARING_KEY={{ rb_key }}
      {% endif %}
    depends_on:
      - readsb

  opensky:
    image: ghcr.io/sdr-enthusiasts/docker-opensky-feeder:latest
    restart: always
    environment:
      - BEASTHOST=readsb
      - BEASTPORT=30005
      {% if opensky_username is defined %}
      - OPENSKY_USERNAME={{ opensky_username }}
      - OPENSKY_SERIAL={{ opensky_serial }}
      {% endif %}
    depends_on:
      - readsb
