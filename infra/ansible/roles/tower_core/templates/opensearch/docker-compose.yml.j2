version: '3'
services:
  # --------------------------------------------------------------------------
  # OPENSEARCH (The Database)
  # --------------------------------------------------------------------------
  opensearch-node:
    image: opensearchproject/opensearch:latest
    container_name: opensearch-node
    environment:
      - cluster.name=adsb-research-grid
      - discovery.type=single-node
      # RAM ALLOCATION: We give it 4GB min/max.
      # This leaves ~11GB for System + Arkime + InfluxDB.
      - "OPENSEARCH_JAVA_OPTS=-Xms4g -Xmx4g"
      # SECURITY: For a research grid, we disable the complex SSL/Auth requirement
      # to prevent "Certificate Hell" during setup.
      # WARNING: Only do this because you are on a private ZeroTier/VLAN network.
      - "OPENSEARCH_INITIAL_ADMIN_PASSWORD={{ vault_opensearch_password }}"      
      - plugins.security.disabled=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - ./data:/usr/share/opensearch/data
    ports:
      - "9200:9200" # REST API
      - "9600:9600" # Perf Analyzer
    restart: unless-stopped
    networks:
      - adsb-net

  # --------------------------------------------------------------------------
  # OPENSEARCH DASHBOARDS (The UI - "Kibana")
  # --------------------------------------------------------------------------
  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:latest
    container_name: opensearch-dashboards
    ports:
      - "5601:5601" # Web Interface
    expose:
      - "5601"
    environment:
      - 'OPENSEARCH_HOSTS=["http://opensearch-node:9200"]'
      - "DISABLE_SECURITY_DASHBOARDS_PLUGIN=true"
    restart: unless-stopped
    networks:
      - adsb-net
    depends_on:
      - opensearch-node

networks:
  adsb-net:
    driver: bridge
