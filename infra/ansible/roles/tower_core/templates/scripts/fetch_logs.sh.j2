#!/bin/bash
# ==============================================================================
# ğŸ“¡ PROJECT: ADS-B Spoofing Data Collection
# ğŸ“‚ FILE:    /opt/adsb-grid/scripts/fetch_logs.sh
# ğŸ”¢ VERSION: 0.7.4 (Fixed Recursive Path for Health & Storage)
# ğŸ“… DATE:    2026-01-13
# ------------------------------------------------------------------------------
# DESCRIPTION: Aggregates raw CSV research data from all Sensor Nodes to Tower.
#              Designed to run via Cron (Hourly) or manual trigger.
# SOURCE:      /var/lib/adsb_storage/ (Parent Directory)
# DESTINATION: /opt/adsb-grid/data/raw/ (On Tower)
# ==============================================================================

# --- Configuration ---
DEST_ROOT="/opt/adsb-grid/data/raw"
LOG_FILE="/var/log/adsb-fetch.log"
DATE=$(date +%Y-%m-%d)

# Sensor Definitions (Hostname:IP)
declare -A SENSORS=( 
    ["sensor-north"]="192.168.192.130" 
    ["sensor-west"]="192.168.192.110" 
    ["sensor-east"]="192.168.192.120" 
)

# --- Functions ---
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# --- Execution ---
log "ğŸš€ Starting Hourly Science Data Ingest (v0.7.4) for $DATE"

# Ensure destination exists
mkdir -p "$DEST_ROOT"

for SENSOR_NAME in "${!SENSORS[@]}"; do
    SENSOR_IP="${SENSORS[$SENSOR_NAME]}"
    TARGET_DIR="$DEST_ROOT/$SENSOR_NAME"
    
    mkdir -p "$TARGET_DIR"
    
    log "ğŸ“¡ Probing $SENSOR_NAME ($SENSOR_IP)..."
    
    # 1. Connectivity Check
    if ping -c 1 -W 2 "$SENSOR_IP" &> /dev/null; then
        
        log "   > Syncing Science CSV/JSON datasets..."
        
        # 2. RSYNC Operation
        # FIXED: Source is now /var/lib/adsb_storage/ (The Parent)
        # --include="*/": Essential to traverse subdirectories like 'csv_data/'
        if rsync -avz --timeout=30 \
           --include="*/" \
           --include="*.csv" \
           --include="*.json" \
           --include="*.gz" \
           --include="*.log" \
           --exclude="*" \
           -e "ssh -o StrictHostKeyChecking=no -i /home/{{ ansible_user }}/.ssh/id_rsa" \
           "pi@$SENSOR_IP:/var/lib/adsb_storage/" "$TARGET_DIR/"; then
            
            log "   âœ… Success: Data synced for $SENSOR_NAME"
        else
            log "   âŒ Error: Rsync failed for $SENSOR_NAME"
        fi
        
    else
        log "âš ï¸ Warning: $SENSOR_NAME is unreachable (Ping failed)"
    fi
done

# --- Maintenance ---
# Compress raw CSVs on Tower > 24h old
find "$DEST_ROOT" -type f -name "*.csv" -mtime +1 -exec gzip {} \;

log "ğŸ Ingest Cycle Complete."
